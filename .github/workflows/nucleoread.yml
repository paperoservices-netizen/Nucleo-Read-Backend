name: Nucleoread ‚Äì Genomic Analysis Engine

on:
  workflow_dispatch:
    inputs:
      query:
        description: "FASTA sequence (paste raw, multiline allowed)"
        required: true
      job_id:
        description: "Unique job ID"
        required: true

jobs:
  run-nucleoread:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3Ô∏è‚É£ Dependencies
      - name: Install deps
        run: |
          pip install -r requirements.txt

      # 4Ô∏è‚É£ Save FASTA safely (CRITICAL FIX)
      - name: Write FASTA input
        run: |
          mkdir -p python-runner/input
          cat << 'EOF' > python-runner/input/${{ github.event.inputs.job_id }}.fasta
${{ github.event.inputs.query }}
EOF

      # 5Ô∏è‚É£ Run Nucleoread
      - name: Run Nucleoread
        run: |
          echo "üî¨ Running Nucleoread job ${{ github.event.inputs.job_id }}"
          python python-runner/run_job.py \
            python-runner/input/${{ github.event.inputs.job_id }}.fasta \
            ${{ github.event.inputs.job_id }}

      # 6Ô∏è‚É£ Verify outputs
      - name: Verify outputs
        run: |
          JSON="python-runner/results/${{ github.event.inputs.job_id }}.json"
          GC="python-runner/images/${{ github.event.inputs.job_id }}_gc.png"
          GEL="python-runner/images/${{ github.event.inputs.job_id }}_gel.png"

          test -f "$JSON" || (echo "‚ùå Missing JSON" && exit 1)
          test -f "$GC" || (echo "‚ùå Missing GC plot" && exit 1)
          test -f "$GEL" || (echo "‚ùå Missing gel plot" && exit 1)

          echo "‚úÖ All outputs generated"

      # 7Ô∏è‚É£ Upload artifacts (best practice)
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: nucleoread-${{ github.event.inputs.job_id }}
          path: |
            python-runner/results/${{ github.event.inputs.job_id }}.json
            python-runner/images/${{ github.event.inputs.job_id }}_gc.png
            python-runner/images/${{ github.event.inputs.job_id }}_gel.png
