name: Nucleoread – Genomic Analysis Engine

on:
  workflow_dispatch:
    inputs:
      query:
        description: "Base64 encoded FASTA sequence"
        required: true
      job_id:
        description: "Unique job ID"
        required: true

jobs:
  run-nucleoread:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2️⃣ Setup Python
      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3️⃣ Install dependencies
      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4️⃣ Run Nucleoread Engine
      - name: Run Nucleoread
        run: |
          python python-runner/run_job.py \
          "${{ github.event.inputs.query }}" \
          "${{ github.event.inputs.job_id }}"


      # 5️⃣ Verify outputs
      - name: Verify outputs
        run: |
          JSON="python-runner/results/${{ github.event.inputs.job_id }}.json"
          GC="python-runner/images/${{ github.event.inputs.job_id }}_gc.png"
          GEL="python-runner/images/${{ github.event.inputs.job_id }}_gel.png"

          if [ ! -f "$JSON" ]; then
            echo "❌ Missing JSON"
            exit 1
          fi

          if [ ! -f "$GC" ]; then
            echo "❌ Missing GC plot"
            exit 1
          fi

          if [ ! -f "$GEL" ]; then
            echo "❌ Missing gel plot"
            exit 1
          fi

          echo "✅ All outputs generated"

      # 6️⃣ Commit & push results
      - name: Commit results
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add python-runner/results/${{ github.event.inputs.job_id }}.json
          git add python-runner/images/${{ github.event.inputs.job_id }}_gc.png
          git add python-runner/images/${{ github.event.inputs.job_id }}_gel.png

          git commit -m "Nucleoread result for job ${{ github.event.inputs.job_id }}" || echo "Nothing to commit"
          git push

      # 7️⃣ Cleanup old files (30 days)
      - name: Cleanup old results
        run: |
          find python-runner/results -type f -mtime +30 -delete
          find python-runner/images -type f -mtime +30 -delete
